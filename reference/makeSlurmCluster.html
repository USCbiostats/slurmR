<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Create a Parallel Socket Cluster using Slurm — makeSlurmCluster • slurmR</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Create a Parallel Socket Cluster using Slurm — makeSlurmCluster"><meta property="og:description" content="This function is essentially a wrapper of the function parallel::makePSOCKcluster.
makeSlurmCluster main feature is adding node addresses."><meta property="og:image" content="/logo.svg"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108627422-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108627422-2');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">slurmR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5-2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/debugging-re-submission.html">Re-submission and debugging</a>
    </li>
    <li>
      <a href="../articles/getting-started.html">Getting Started with slurmR</a>
    </li>
    <li>
      <a href="../articles/working-with-slurm.html">Working with Slurm</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/USCbiostats/slurmR/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a Parallel Socket Cluster using Slurm</h1>
    <small class="dont-index">Source: <a href="https://github.com/USCbiostats/slurmR/blob/HEAD/R/makeSlurmCluster.R" class="external-link"><code>R/makeSlurmCluster.R</code></a></small>
    <div class="hidden name"><code>makeSlurmCluster.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function is essentially a wrapper of the function <a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster</a>.
<code>makeSlurmCluster</code> main feature is adding node addresses.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">makeSlurmCluster</span><span class="op">(</span></span>
<span>  <span class="va">n</span>,</span>
<span>  job_name <span class="op">=</span> <span class="fu"><a href="random_job_name.html">random_job_name</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  tmp_path <span class="op">=</span> <span class="va">opts_slurmR</span><span class="op">$</span><span class="fu">get_tmp_path</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  cluster_opt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  max_wait <span class="op">=</span> <span class="fl">300L</span>,</span>
<span>  verb <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for slurm_cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>n</dt>
<dd><p>Integer scalar. Size of the cluster object (see details).</p></dd>


<dt>job_name</dt>
<dd><p>Character. Name of the job to be passed to <code>Slurm</code>.</p></dd>


<dt>tmp_path</dt>
<dd><p>Character. Path to the directory where all the data (including
scripts) will be stored. Notice that this path must be accessible by all the
nodes in the network (See <a href="opts_slurmR.html">opts_slurmR</a>).</p></dd>


<dt>cluster_opt</dt>
<dd><p>A list of arguments passed to <a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster</a>.</p></dd>


<dt>max_wait</dt>
<dd><p>Integer scalar. Wait time before exiting with error while
trying to read the nodes information.</p></dd>


<dt>verb</dt>
<dd><p>Logical scalar. If <code>TRUE</code>, the function will print messages on
screen reporting on the status of the job submission.</p></dd>


<dt>...</dt>
<dd><p>Further arguments passed to <a href="Slurm_EvalQ.html">Slurm_EvalQ</a> via <code>sbatch_opt</code>.</p></dd>


<dt>cl</dt>
<dd><p>An object of class <code>slurm_cluster</code>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>A object of class <code>c("slurm_cluster", "SOCKcluster", "cluster")</code>. It
is the same as what is returned by <a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster</a> with the main
difference that it has two extra attributes:</p><ul><li><p><code>SLURM_JOBID</code> Which is the id of the Job that initialized that cluster.</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>By default, if the <code>time</code> option is not specified via <code>...</code>,
then it is set to the value <code>01:00:00</code>, this is, 1 hour.</p>
<p>Once a job is submitted via Slurm, the user gets access to the nodes
associated with it, which allows users to star new processes within those.
By means of this, we can create Socket, also known as "PSOCK", clusters across
nodes in a Slurm environment. The name of the hosts are retrieved and passed
later on to <a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster</a>.</p>
<p>It has been the case that R fails to create the cluster with the following
message in the Slurm log file:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>srun<span class="sc">:</span> fatal<span class="sc">:</span> SLURM_MEM_PER_CPU, SLURM_MEM_PER_GPU, and SLURM_MEM_PER_NODE are mutually exclusive</span></code></pre><p></p></div>
<p>In such cases, setting the memory, for example, upfront can solve the problem.
For example:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeSlurmCluster</span>(<span class="dv">20</span>, <span class="at">mem =</span> <span class="dv">20</span>)</span></code></pre><p></p></div>
<p>If the problem persists, i.e., the cluster cannot be created, make sure that
your Slurm cluster allows Socket connections between nodes.</p>
<p>The method <code>stopCluster</code> for <code>slurm_cluster</code> stops the cluster doing
the following:</p><ol><li><p>Closes the connection by calling the <code>stopCluster</code> method for <code>PSOCK</code> objects.</p></li>
<li><p>Cancel the Slurm job using <code>scancel</code>.</p></li>
</ol></div>
    <div id="maximum-number-of-connections">
    <h2>Maximum number of connections</h2>
    


<p>By default, R limits the number of simultaneous connections (see this thread
in R-sig-hpc <a href="https://stat.ethz.ch/pipermail/r-sig-hpc/2012-May/001373.html" class="external-link">https://stat.ethz.ch/pipermail/r-sig-hpc/2012-May/001373.html</a>)
Current maximum is 128 (R version 3.6.1). To modify that limit, you would need
to reinstall R updating the macro <code>NCONNECTIONS</code> in the file <code>src/main/connections.c</code>.</p>
<p>For now, if the user sets <code>n</code> above 128 it will get an immediate warning
pointing to this issue, in particular, specifying that the cluster object
may not be able to be created.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Creating a cluster with 100 workers/offpring/child R sessions</span></span></span>
<span class="r-in"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeSlurmCluster</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Computing the mean of a 100 random uniforms within each worker</span></span></span>
<span class="r-in"><span><span class="co"># for this we can use any of the function available in the parallel package.</span></span></span>
<span class="r-in"><span><span class="va">ans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parSapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We simply call stopCluster as we would do with any other cluster</span></span></span>
<span class="r-in"><span><span class="co"># object</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">ans</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We can also specify SBATCH options directly (...)</span></span></span>
<span class="r-in"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeSlurmCluster</span><span class="op">(</span><span class="fl">200</span>, partition <span class="op">=</span> <span class="st">"thomas"</span>, time <span class="op">=</span> <span class="st">"02:00:00"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by George Vega Yon, National Cancer Institute (NCI).</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

